<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>autotaker's blog - Haskellでスクレイピング、haskell-src-extsのバグ</title>
        <link rel="stylesheet" href="../css/default.css" />
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    </head>
    <body>
        <div class="content">
        <header>
            <div class="logo">
                <a href="../">autotaker's blog</a>
            </div>
            <nav>
                <a href="../profile.html">Profile</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>Haskellでスクレイピング、haskell-src-extsのバグ</h1>
            <article>
    <section class="header">
        Posted on March 12, 2019<br>
        
    </section>
    <section class="header">
        
        Tags: <a href="../tags/%E6%97%A5%E8%A8%98.html">日記</a>
        
    </section>
    <section>
        <p>AtCoderの自動化プラグインを作りたくてスクレイピングを始めた。 Haskellでスクレイピングでググると <a href="https://qiita.com/na-o-ys/items/30a4950d5391911493c2">Haskell で楽しい Web スクレイピング</a> という記事がヒットした。 <code>scalpel</code>というライブラリを使えばいいらしい。</p>
<p>試しにAtcoderのページにログインして見ることにした。 が、意外と手こずった。まず、<code>scalpel</code>単体ではセッションの管理ができない。 仕方ないので、Cookieを操作するミドルウェアを書いていたのだが途中で車輪の再生産は良くないと思い ライブラリを探した。 次に見つけたのは<code>http-conduit-browser</code>というライブラリ。 使って見てビルドしようとしたらパッケージが壊れていた。よくよくpackage descriptionを読むと</p>
<blockquote>
<p>This package creates a monad representing things that browsers do, letting you elegantly describe a browsing session. This package wraps the http-conduit package by Michael Snoyman. This package is deprecated, use http://hackage.haskell.org/package/wreq instead</p>
</blockquote>
<p><strong>This package is deprecated, use http://hackage.haskell.org/package/wreq instead</strong></p>
<p>はい。 全く英語が読めていない。</p>
<p>ここで紹介されている<code>wreq</code>というライブラリを使って見る。 すごく直感的だ。GETでアクセスするには<code>get :: String -&gt; IO (Response ByteString)</code>を呼べばよく、 POSTでアクセスするには<code>post :: Postable a =&gt; String -&gt; a -&gt; IO (Response ByteString)</code>を叩けば良い。 そうそう、こういうのでいいんだよ。</p>
<p>セッションを管理したくなったら<code>Network.Wreq.Session</code>の関数を使えば良い。使い方も簡単だ。 これで楽勝かと思ったが、AtCoderにログインしようとしたら<code>csrf tokens mismatch</code>と言われてしまう。 しばらく悩んだ結果、<code>application/json</code>でフォームを送信していたのを<code>application/x-www-form-urlencoded</code>に直したらログインできた。</p>
<p>これを開発している途中に<code>hlint</code>のバグを見つけた。（実際はhaskell-src-extsのバグだが） HIE上でHaskellのコードを編集すると、勝手にhlintをかけてhintを表示してくれるのだが、なぜか <code>hlint</code>がパーズエラーを投げていた。しかし手元のターミナルで直接<code>hlint Program.hs</code>を叩いても全然再現しない。 バグを特定したところ、HIEがhlintをかけるとき勝手に<code>TypeApplications</code>の拡張を有効にすることがわかった。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="ot">runLintCmd ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">ExceptT</span> [<span class="dt">Diagnostic</span>] <span class="dt">IO</span> [<span class="dt">Idea</span>]</a>
<a class="sourceLine" id="cb1-2" title="2">runLintCmd fp args <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-3" title="3">  (flags,classify,hint) <span class="ot">&lt;-</span> liftIO <span class="fu">$</span> argsSettings args</a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="kw">let</span> myflags <span class="fu">=</span> flags { hseFlags <span class="fu">=</span> (hseFlags flags) { extensions <span class="fu">=</span> <span class="dt">EnableExtension</span> <span class="dt">TypeApplications</span><span class="fu">:</span>extensions (hseFlags flags)}}</a>
<a class="sourceLine" id="cb1-5" title="5">  res <span class="ot">&lt;-</span> bimapExceptT parseErrorToDiagnostic <span class="fu">id</span> <span class="fu">$</span> <span class="dt">ExceptT</span> <span class="fu">$</span> parseModuleEx myflags fp <span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="fu">pure</span> <span class="fu">$</span> applyHints classify hint [res]</a></code></pre></div>
<p><a href="https://github.com/haskell/haskell-ide-engine/blob/65225fe9c4314b44fd2f9f3c0a4067961ee872cc/src/Haskell/Ide/Engine/Plugin/ApplyRefact.hs#L117">ソース</a></p>
<p>謎の仕様ではあるが、まあなんらかの理由があってこういうことをしているのだろう。 とりあえず回避策としては<code>NoTypeApplications</code>プラグマを書いておけば良い。 真の問題は<code>TypeApplications</code>を有効にすると<code>hlint</code>が正しくパーズしてくれないということだ。 バグを調べたところ<code>haskell-src-exts</code>の<a href="https://github.com/haskell-suite/haskell-src-exts/issues/326">issue</a> が見つかった。<code>TypeApplications</code>が有効になっていると<code>@:</code>という演算子がパーズできなくなるというバグだ。 面白いのは<code>@=</code>とか<code>@@</code>などの演算子は正しくパーズできるというところだ。<code>@:</code>で始まる演算子のみがパーズできない。</p>
<p>1行修正すれば治るバグのようだったので修正してプルリクを投げた。マージされると嬉しいな。</p>
<p>話は変わるが<code>neovim</code> + <code>vim-lsp</code>経由でHIEを動かしているのだが、重すぎて正直使い物にならない。 カーソルを１つ動かすたびに数百ms待たされる。どれを使えば良いのやら。</p>
    </section>
    
    <div id="disqus_thread"></div>
    <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    var disqus_config = function () {
    this.page.url = "https://autotaker.github.io" + "/posts/2019-03-12-scraping-and-hse.html";  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = "/posts/2019-03-12-scraping-and-hse.html"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://autotaker.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
        </div>
    </body>
</html>
