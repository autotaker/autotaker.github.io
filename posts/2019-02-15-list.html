<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>autotaker's blog - GHCの融合変換を理解する(前編)</title>
        <link rel="stylesheet" href="../css/default.css" />
        <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    </head>
    <body>
        <div class="content">
        <header>
            <div class="logo">
                <a href="../">autotaker's blog</a>
            </div>
            <nav>
                <a href="../profile.html">Profile</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>GHCの融合変換を理解する(前編)</h1>
            <article>
    <section class="header">
        Posted on February 15, 2019<br>
        
    </section>
    <section class="header">
        
        Tags: <a href="../tags/Haskell.html">Haskell</a>, <a href="../tags/GHC.html">GHC</a>
        
    </section>
    <section>
        <h1 id="今回のお題">今回のお題</h1>
<p>GHCで<code>sum [1,2,3]</code>はどのようにコンパイルされるでしょうか。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">module</span> <span class="dt">Sum</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="ot">sum123 ::</span> <span class="dt">Int</span></a>
<a class="sourceLine" id="cb1-3" title="3">sum123 <span class="fu">=</span> <span class="fu">sum</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] </a></code></pre></div>
<p>コンパイルしてみると定数<code>6</code>となっていることがわかります。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb2-1" title="1">$ <span class="ex">stack</span> ghc -- -O Sum.hs</a>
<a class="sourceLine" id="cb2-2" title="2">$ <span class="ex">stack</span> ghc -- --show-iface Sum.hi</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw">(</span>中略<span class="kw">)</span></a>
<a class="sourceLine" id="cb2-4" title="4"><span class="ex">1eb3421a20d14a1255f6f5adccf8e3bd</span></a>
<a class="sourceLine" id="cb2-5" title="5">  <span class="ex">sum123</span> :: GHC.Types.Int</a>
<a class="sourceLine" id="cb2-6" title="6">    {<span class="ex">-</span> HasNoCafRefs, Strictness: m, Unfolding: (GHC.Types.I# 6#) <span class="ex">-</span>}</a></code></pre></div>
<p>今回の記事では、GHCはどのように6を計算しているのか解説します。 ポイントはリストリテラルの脱糖と、fold/build変換です。</p>
<h1 id="リストリテラル">リストリテラル</h1>
<p><code>ghc</code>に<code>-ddump-ds</code>オプションを渡すと脱糖の結果をみることができます。</p>
<p><code>-O</code>オプションがない場合、GHCは<code>[1,2,3]</code>を<code>1 : 2: 3 : []</code>に脱糖します。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1">$ <span class="ex">stack</span> ghc -- -ddump-ds Sum.hs</a>
<a class="sourceLine" id="cb3-2" title="2">[<span class="ex">1</span> of 1] Compiling Sum              ( Sum.hs, Sum.o ) [<span class="ex">Optimisation</span> flags changed]</a>
<a class="sourceLine" id="cb3-3" title="3">==================== <span class="ex">Desugar</span> (after optimization) ====================</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="ex">...</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="ex">--</span> RHS size: {terms: 13, types: 6, coercions: 0, joins: 0/0}</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="ex">sum123</span> :: Int</a>
<a class="sourceLine" id="cb3-7" title="7">[<span class="ex">LclIdX</span>]</a>
<a class="sourceLine" id="cb3-8" title="8"><span class="ex">sum123</span></a>
<a class="sourceLine" id="cb3-9" title="9">  = <span class="fu">sum</span></a>
<a class="sourceLine" id="cb3-10" title="10">      <span class="ex">@</span> []</a>
<a class="sourceLine" id="cb3-11" title="11">      <span class="ex">Data.Foldable.</span><span class="va">$fFoldable[]</span></a>
<a class="sourceLine" id="cb3-12" title="12">      <span class="ex">@</span> Int</a>
<a class="sourceLine" id="cb3-13" title="13">      <span class="ex">GHC.Num.</span><span class="va">$fNumInt</span></a>
<a class="sourceLine" id="cb3-14" title="14">      <span class="kw">(</span><span class="ex">GHC.Types.</span>:</a>
<a class="sourceLine" id="cb3-15" title="15">         <span class="ex">@</span> Int</a>
<a class="sourceLine" id="cb3-16" title="16">         <span class="kw">(</span><span class="ex">GHC.Types.I</span># 1#<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-17" title="17">         <span class="kw">(</span><span class="ex">GHC.Types.</span>:</a>
<a class="sourceLine" id="cb3-18" title="18">            <span class="ex">@</span> Int</a>
<a class="sourceLine" id="cb3-19" title="19">            <span class="kw">(</span><span class="ex">GHC.Types.I</span># 2#<span class="kw">)</span></a>
<a class="sourceLine" id="cb3-20" title="20">            <span class="kw">(</span><span class="ex">GHC.Types.</span>: @ Int (GHC.Types.I# 3#<span class="kw">)</span> <span class="kw">(</span><span class="ex">GHC.Types.</span>[] @ Int<span class="kw">)))</span>)</a></code></pre></div>
<p>一方で、<code>-O</code>がある場合は<code>build (\c n -&gt; c 1 (c 2 (c 3 n)))</code>という式に脱糖します。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" title="1">$ <span class="ex">stack</span> ghc -- -O -ddump-ds Sum.hs</a>
<a class="sourceLine" id="cb4-2" title="2">[<span class="ex">1</span> of 1] Compiling Sum              ( Sum.hs, Sum.o ) [<span class="ex">Optimisation</span> flags changed]</a>
<a class="sourceLine" id="cb4-3" title="3">==================== <span class="ex">Desugar</span> (after optimization) ====================</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="ex">--</span> RHS size: {terms: 17, types: 9, coercions: 0, joins: 0/0}</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="ex">sum123</span> :: Int</a>
<a class="sourceLine" id="cb4-6" title="6">[<span class="ex">LclIdX</span>]</a>
<a class="sourceLine" id="cb4-7" title="7"><span class="ex">sum123</span></a>
<a class="sourceLine" id="cb4-8" title="8">  = <span class="fu">sum</span></a>
<a class="sourceLine" id="cb4-9" title="9">      <span class="ex">@</span> []</a>
<a class="sourceLine" id="cb4-10" title="10">      <span class="ex">Data.Foldable.</span><span class="va">$fFoldable[]</span></a>
<a class="sourceLine" id="cb4-11" title="11">      <span class="ex">@</span> Int</a>
<a class="sourceLine" id="cb4-12" title="12">      <span class="ex">GHC.Num.</span><span class="va">$fNumInt</span></a>
<a class="sourceLine" id="cb4-13" title="13">      <span class="kw">(</span><span class="ex">GHC.Base.build</span></a>
<a class="sourceLine" id="cb4-14" title="14">         <span class="ex">@</span> Int</a>
<a class="sourceLine" id="cb4-15" title="15">         <span class="kw">(</span><span class="ex">\ </span>(@ a_d1v6<span class="kw">)</span></a>
<a class="sourceLine" id="cb4-16" title="16">            <span class="kw">(</span><span class="ex">c_d1v7</span> [OS=OneShot] :: Int -<span class="op">&gt;</span> a_d1v6 -<span class="op">&gt;</span> a_d1v6<span class="kw">)</span></a>
<a class="sourceLine" id="cb4-17" title="17">            <span class="kw">(</span><span class="ex">n_d1v8</span> [OS=OneShot] :: a_d1v6<span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb4-18" title="18">            <span class="ex">c_d1v7</span></a>
<a class="sourceLine" id="cb4-19" title="19">              <span class="kw">(</span><span class="ex">GHC.Types.I</span># 1#<span class="kw">)</span></a>
<a class="sourceLine" id="cb4-20" title="20">              <span class="kw">(</span><span class="ex">c_d1v7</span> (GHC.Types.I# 2#<span class="kw">)</span> <span class="kw">(</span><span class="ex">c_d1v7</span> (GHC.Types.I# 3#<span class="kw">)</span> <span class="ex">n_d1v8</span><span class="kw">)</span>)))</a></code></pre></div>
<p>ここで<code>build</code>は<code>GHC.Base</code>で定義される関数です。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" title="1"><span class="ot">build ::</span> (<span class="kw">forall</span> b<span class="fu">.</span> (a <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> [a]</a>
<a class="sourceLine" id="cb5-2" title="2">build g <span class="fu">=</span> g (<span class="fu">:</span>) []</a></code></pre></div>
<p><code>g c n</code>は、とあるリストの <code>(:)</code>コンストラクタを<code>c</code>に、<code>[]</code>コンストラクタを<code>n</code>にそれぞれ置き換える関数と考えると 良いです。<code>build</code>はそのような<code>g</code>を受け取り、<code>c</code>として<code>(:)</code>、<code>n</code>として<code>[]</code>を渡すことで リストを生成します。</p>
<p>つまり、脱糖の結果、</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" title="1"><span class="fu">sum</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] <span class="fu">==&gt;</span> <span class="fu">sum</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n))))</a></code></pre></div>
<p>となります。</p>
<p>次に、<code>sum</code>関数です。これは(Foldable型クラスを具象化すると)以下のような定義になります。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" title="1"><span class="fu">sum</span><span class="ot"> ::</span> (<span class="dt">Num</span> a) <span class="ot">=&gt;</span> [a] <span class="ot">-&gt;</span> a</a>
<a class="sourceLine" id="cb7-2" title="2"><span class="fu">sum</span> <span class="fu">=</span> <span class="fu">foldl</span> (<span class="fu">+</span>) <span class="dv">0</span></a></code></pre></div>
<p>次にfoldl関数の定義を見てみましょう。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" title="1"><span class="fu">foldl</span><span class="ot"> ::</span> <span class="kw">forall</span> a b<span class="fu">.</span> (b <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> b) <span class="ot">-&gt;</span> b <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> b</a>
<a class="sourceLine" id="cb8-2" title="2"><span class="ot">{-# INLINE foldl #-}</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="fu">foldl</span> k z0 xs <span class="fu">=</span></a>
<a class="sourceLine" id="cb8-4" title="4">  <span class="fu">foldr</span> (\(<span class="ot">v::</span>a) (<span class="ot">fn::</span>b<span class="ot">-&gt;</span>b) <span class="ot">-&gt;</span> oneShot (\(<span class="ot">z::</span>b) <span class="ot">-&gt;</span> fn (k z v))) (<span class="fu">id</span><span class="ot"> ::</span> b <span class="ot">-&gt;</span> b) xs z0</a></code></pre></div>
<p><a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/src/GHC.List.html#foldl">ソース</a></p>
<p>驚くべきことに<code>foldl</code>は<code>foldr</code>を使って書かれています。 その理由はコメントで書かれています。</p>
<blockquote>
<p>Note [Left folds via right fold]</p>
<p>Implementing foldl et. al. via foldr is only a good idea if the compiler can optimize the resulting code (eta-expand the recursive “go”). See #7994. We hope that one of the two measure kick in:</p>
<ul>
<li>Call Arity (-fcall-arity, enabled by default) eta-expands it if it can see all calls and determine that the arity is large.</li>
<li>The oneShot annotation gives a hint to the regular arity analysis that it may assume that the lambda is called at most once. See [One-shot lambdas] in CoreArity and especially [Eta expanding thunks] in CoreArity. The oneShot annotations used in this module are correct, as we only use them in arguments to foldr, where we know how the arguments are called. <code>oneShot</code></li>
</ul>
</blockquote>
<p>要は、コンパイラがη展開してくれるから途中で生成されるクロージャは消えるので 問題ないということです。そして、 <code>foldl</code>が<code>foldr</code>で書かれていることにはある重要な理由があります。 それは<strong><code>fold/build</code>変換が効く</strong>ということです。これについては後述します。</p>
<p>さて、ghcはこれらの定義に従ってコードをインライン展開します。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" title="1"><span class="fu">sum</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] </a>
<a class="sourceLine" id="cb9-2" title="2">    <span class="fu">==&gt;</span> <span class="fu">sum</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n)))) <span class="co">-- desugar</span></a>
<a class="sourceLine" id="cb9-3" title="3">    <span class="fu">==&gt;</span> <span class="fu">foldl</span> (<span class="fu">+</span>) <span class="dv">0</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n)))) <span class="co">-- inline sum</span></a>
<a class="sourceLine" id="cb9-4" title="4">    <span class="fu">==&gt;</span> <span class="fu">foldr</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="fu">id</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n)))) <span class="dv">0</span> <span class="co">-- inline foldl  </span></a></code></pre></div>
<h1 id="foldbuild変換">fold/build変換</h1>
<p>さて、fold/build変換は<a href="http://hackage.haskell.org/package/base-4.12.0.0/docs/src/GHC.Base.html#line-1060">ここ</a>で定義されています。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" title="1"><span class="ot">{-# RULES</span></a>
<a class="sourceLine" id="cb10-2" title="2"><span class="ot">&quot;fold/build&quot;    forall k z (g::forall b. (a-&gt;b-&gt;b) -&gt; b -&gt; b) .</span></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="ot">                foldr k z (build g) = g k z</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="ot"> #-}</span></a></code></pre></div>
<p>まず<code>RULES</code>プラグマについて説明します。これは<strong>左辺で書かれた式を右辺の式に書き換える</strong> というGHCの持つ強力な<del>(黒魔術)</del>最適化機構です。 今回の場合は「<code>foldr k z (build g)</code>の形をした式を<code>g k z</code>に書き換える」ということを意味しています。 この書き換えが正しいこと、および書き換えが停止することは完全に <strong>ライブラリ製作者の責任</strong>です。 実際、このfold/build変換が正しいかどうかは自明ではありません。 ほとんどの場合は問題ないことが知られていますが、 <code>seq</code>と<code>undefined</code>をうまく使うと左辺と右辺で結果が異なる例が存在します。<a href="https://wiki.haskell.org/Correctness_of_short_cut_fusion">参考</a></p>
<p>さて、今回の式でもfold/build変換が適用できる形をしているので変換してみましょう。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" title="1"><span class="fu">sum</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] </a>
<a class="sourceLine" id="cb11-2" title="2">    <span class="fu">==&gt;</span> <span class="fu">foldr</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="fu">id</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n)))) <span class="dv">0</span> </a>
<a class="sourceLine" id="cb11-3" title="3">    <span class="fu">==&gt;</span> (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n))) (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="fu">id</span> <span class="dv">0</span> <span class="co">-- fold/build</span></a></code></pre></div>
<p>実際の変換はghcに<code>-ddump-rule-rewrites</code>オプションを渡すと確認できます。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb12-1" title="1">$ <span class="ex">stack</span> ghc -- -O -ddump-rule-rewrites Sum.hs</a>
<a class="sourceLine" id="cb12-2" title="2"><span class="ex">...</span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="ex">Rule</span> fired</a>
<a class="sourceLine" id="cb12-4" title="4">    <span class="ex">Rule</span>: fold/build</a>
<a class="sourceLine" id="cb12-5" title="5">    <span class="ex">Module</span>: (GHC.Base)</a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="ex">Before</span>: GHC.Base.foldr</a>
<a class="sourceLine" id="cb12-7" title="7">              <span class="ex">TyArg</span> GHC.Types.Int</a>
<a class="sourceLine" id="cb12-8" title="8">              <span class="ex">TyArg</span> GHC.Types.Int -<span class="op">&gt;</span> GHC.Types.Int</a>
<a class="sourceLine" id="cb12-9" title="9">              <span class="ex">ValArg</span> <span class="dt">\ </span>(ds_a2Bp :: GHC.Types.Int)</a>
<a class="sourceLine" id="cb12-10" title="10">                       <span class="kw">(</span><span class="ex">ds1_a2Bq</span> [OS=OneShot] :: GHC.Types.Int -<span class="op">&gt;</span> GHC.Types.Int<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-11" title="11">                       <span class="kw">(</span><span class="ex">v_a2Br</span> [OS=OneShot] :: GHC.Types.Int<span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb12-12" title="12">                       <span class="ex">ds1_a2Bq</span> (GHC.Num.<span class="va">$fNumInt_$c</span>+ v_a2Br ds_a2Bp)</a>
<a class="sourceLine" id="cb12-13" title="13">              <span class="ex">ValArg</span> GHC.Base.id @ GHC.Types.Int</a>
<a class="sourceLine" id="cb12-14" title="14">              <span class="ex">ValArg</span> GHC.Base.build</a>
<a class="sourceLine" id="cb12-15" title="15">                       <span class="ex">@</span> GHC.Types.Int</a>
<a class="sourceLine" id="cb12-16" title="16">                       <span class="kw">(</span><span class="ex">\ </span>(@ a_d1va<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-17" title="17">                          <span class="kw">(</span><span class="ex">c_d1vb</span> [OS=OneShot] :: GHC.Types.Int -<span class="op">&gt;</span> a_d1va -<span class="op">&gt;</span> a_d1va<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-18" title="18">                          <span class="kw">(</span><span class="ex">n_d1vc</span> [OS=OneShot] :: a_d1va<span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb12-19" title="19">                          <span class="ex">c_d1vb</span></a>
<a class="sourceLine" id="cb12-20" title="20">                            <span class="kw">(</span><span class="ex">GHC.Types.I</span># 1#<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-21" title="21">                            <span class="kw">(</span><span class="ex">c_d1vb</span> (GHC.Types.I# 2#<span class="kw">)</span> <span class="kw">(</span><span class="ex">c_d1vb</span> (GHC.Types.I# 3#<span class="kw">)</span> <span class="ex">n_d1vc</span>)))</a>
<a class="sourceLine" id="cb12-22" title="22">    <span class="ex">After</span>:  (<span class="dt">\ </span>(@ b_a2Cu)</a>
<a class="sourceLine" id="cb12-23" title="23">               <span class="kw">(</span><span class="ex">@</span> a_a2Cv<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-24" title="24">               <span class="kw">(</span><span class="ex">k_a2Cw</span> :: a_a2Cv -<span class="op">&gt;</span> b_a2Cu -<span class="op">&gt;</span> b_a2Cu<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-25" title="25">               <span class="kw">(</span><span class="ex">z_a2Cx</span> :: b_a2Cu<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-26" title="26">               <span class="kw">(</span><span class="ex">g_a2Cy</span> :: forall b1. (a_a2Cv -<span class="op">&gt;</span> b1 -<span class="op">&gt;</span> b1<span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span> b1 -<span class="op">&gt;</span> b1) <span class="ex">-</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb12-27" title="27">               <span class="ex">g_a2Cy</span> @ b_a2Cu k_a2Cw z_a2Cx)</a>
<a class="sourceLine" id="cb12-28" title="28">              <span class="ex">@</span> (GHC.Types.Int -<span class="op">&gt;</span> GHC.Types.Int)</a>
<a class="sourceLine" id="cb12-29" title="29">              <span class="ex">@</span> GHC.Types.Int</a>
<a class="sourceLine" id="cb12-30" title="30">              <span class="kw">(</span><span class="ex">\ </span>(ds_a2Bp :: GHC.Types.Int<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-31" title="31">                 <span class="kw">(</span><span class="ex">ds1_a2Bq</span> [OS=OneShot] :: GHC.Types.Int -<span class="op">&gt;</span> GHC.Types.Int<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-32" title="32">                 <span class="kw">(</span><span class="ex">v_a2Br</span> [OS=OneShot] :: GHC.Types.Int<span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb12-33" title="33">                 <span class="ex">ds1_a2Bq</span> (GHC.Num.<span class="va">$fNumInt_$c</span>+ v_a2Br ds_a2Bp))</a>
<a class="sourceLine" id="cb12-34" title="34">              <span class="kw">(</span><span class="ex">GHC.Base.id</span> @ GHC.Types.Int<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-35" title="35">              <span class="kw">(</span><span class="ex">\ </span>(@ a_d1va<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-36" title="36">                 <span class="kw">(</span><span class="ex">c_d1vb</span> [OS=OneShot] :: GHC.Types.Int -<span class="op">&gt;</span> a_d1va -<span class="op">&gt;</span> a_d1va<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-37" title="37">                 <span class="kw">(</span><span class="ex">n_d1vc</span> [OS=OneShot] :: a_d1va<span class="kw">)</span> <span class="ex">-</span><span class="op">&gt;</span></a>
<a class="sourceLine" id="cb12-38" title="38">                 <span class="ex">c_d1vb</span></a>
<a class="sourceLine" id="cb12-39" title="39">                   <span class="kw">(</span><span class="ex">GHC.Types.I</span># 1#<span class="kw">)</span></a>
<a class="sourceLine" id="cb12-40" title="40">                   <span class="kw">(</span><span class="ex">c_d1vb</span> (GHC.Types.I# 2#<span class="kw">)</span> <span class="kw">(</span><span class="ex">c_d1vb</span> (GHC.Types.I# 3#<span class="kw">)</span> <span class="ex">n_d1vc</span>)))</a>
<a class="sourceLine" id="cb12-41" title="41">    <span class="ex">Cont</span>:   ApplyToVal nodup z0_a2Bn</a>
<a class="sourceLine" id="cb12-42" title="42">            <span class="ex">Stop</span>[RhsCtxt] GHC.Types.Int</a></code></pre></div>
<p>fold/build変換の結果β簡約できる箇所が見つかりました。GHCは（簡約結果が大きくなりすぎない限り）このような簡約を自動で行います。 人手でやるのはしんどいですが実際にやってみましょう。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" title="1"><span class="fu">sum</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] </a>
<a class="sourceLine" id="cb13-2" title="2">    <span class="fu">==&gt;</span> <span class="fu">...</span></a>
<a class="sourceLine" id="cb13-3" title="3">    <span class="fu">==&gt;</span> (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n))) (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="fu">id</span> <span class="dv">0</span> <span class="co">-- fold/build</span></a>
<a class="sourceLine" id="cb13-4" title="4">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span>              <span class="co">-- beta</span></a>
<a class="sourceLine" id="cb13-5" title="5">         ((\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">2</span>  </a>
<a class="sourceLine" id="cb13-6" title="6">           ((\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">3</span> <span class="fu">id</span>)) <span class="dv">0</span> </a>
<a class="sourceLine" id="cb13-7" title="7">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span>              <span class="co">-- beta</span></a>
<a class="sourceLine" id="cb13-8" title="8">         ((\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">2</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) z <span class="dv">3</span>))) <span class="dv">0</span> </a>
<a class="sourceLine" id="cb13-9" title="9">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span>              <span class="co">-- beta</span></a>
<a class="sourceLine" id="cb13-10" title="10">         (\z <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) z <span class="dv">3</span>)) ((<span class="fu">+</span>) z <span class="dv">2</span>)) <span class="dv">0</span> </a>
<a class="sourceLine" id="cb13-11" title="11">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) z <span class="dv">2</span>) <span class="dv">3</span>)) <span class="dv">0</span> <span class="co">--beta</span></a>
<a class="sourceLine" id="cb13-12" title="12">    <span class="fu">==&gt;</span> (\z <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) z <span class="dv">2</span>) <span class="dv">3</span>)) ((<span class="fu">+</span>) z <span class="dv">1</span>)) <span class="dv">0</span> <span class="co">--beta</span></a>
<a class="sourceLine" id="cb13-13" title="13">    <span class="fu">==&gt;</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) ((<span class="fu">+</span>) z <span class="dv">1</span>) <span class="dv">2</span>) <span class="dv">3</span>)) <span class="dv">0</span> <span class="co">--beta</span></a>
<a class="sourceLine" id="cb13-14" title="14">    <span class="fu">==&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) ((<span class="fu">+</span>) <span class="dv">0</span> <span class="dv">1</span>) <span class="dv">2</span>) <span class="dv">3</span>) <span class="co">--beta</span></a></code></pre></div>
<p>最後に<code>id</code>がインライン展開され、定数同士の演算がコンパイル時に行われることで、 <code>sum123 ==&gt; 6</code>となります。</p>
<h1 id="結論">結論</h1>
<p>ghcではリストリテラルは<code>build</code>関数を使った定義に脱糖されるため、<code>fold/build</code>変換の対象となります。 最後に変換の全体結果を示します。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" title="1"><span class="fu">sum</span> [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>] </a>
<a class="sourceLine" id="cb14-2" title="2">    <span class="fu">==&gt;</span> <span class="fu">sum</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n)))) <span class="co">-- desugar</span></a>
<a class="sourceLine" id="cb14-3" title="3">    <span class="fu">==&gt;</span> <span class="fu">foldl</span> (<span class="fu">+</span>) <span class="dv">0</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n)))) <span class="co">-- inline sum</span></a>
<a class="sourceLine" id="cb14-4" title="4">    <span class="fu">==&gt;</span> <span class="fu">foldr</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="fu">id</span> (build (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n)))) <span class="dv">0</span> <span class="co">-- inline foldl  </span></a>
<a class="sourceLine" id="cb14-5" title="5">    <span class="fu">==&gt;</span> (\c n <span class="ot">-&gt;</span> c <span class="dv">1</span> (c <span class="dv">2</span> (c <span class="dv">3</span> n))) (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="fu">id</span> <span class="dv">0</span> <span class="co">-- fold/build</span></a>
<a class="sourceLine" id="cb14-6" title="6">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span>              <span class="co">-- beta</span></a>
<a class="sourceLine" id="cb14-7" title="7">         ((\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">2</span>  </a>
<a class="sourceLine" id="cb14-8" title="8">           ((\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">3</span> <span class="fu">id</span>)) <span class="dv">0</span> </a>
<a class="sourceLine" id="cb14-9" title="9">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span>              <span class="co">-- beta</span></a>
<a class="sourceLine" id="cb14-10" title="10">         ((\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">2</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) z <span class="dv">3</span>))) <span class="dv">0</span> </a>
<a class="sourceLine" id="cb14-11" title="11">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span>              <span class="co">-- beta</span></a>
<a class="sourceLine" id="cb14-12" title="12">         (\z <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) z <span class="dv">3</span>)) ((<span class="fu">+</span>) z <span class="dv">2</span>)) <span class="dv">0</span> </a>
<a class="sourceLine" id="cb14-13" title="13">    <span class="fu">==&gt;</span> (\v fn <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> fn ((<span class="fu">+</span>) z v))) <span class="dv">1</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) z <span class="dv">2</span>) <span class="dv">3</span>)) <span class="dv">0</span> <span class="co">--beta</span></a>
<a class="sourceLine" id="cb14-14" title="14">    <span class="fu">==&gt;</span> (\z <span class="ot">-&gt;</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) z <span class="dv">2</span>) <span class="dv">3</span>)) ((<span class="fu">+</span>) z <span class="dv">1</span>)) <span class="dv">0</span> <span class="co">--beta</span></a>
<a class="sourceLine" id="cb14-15" title="15">    <span class="fu">==&gt;</span> (\z <span class="ot">-&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) ((<span class="fu">+</span>) z <span class="dv">1</span>) <span class="dv">2</span>) <span class="dv">3</span>)) <span class="dv">0</span> <span class="co">--beta</span></a>
<a class="sourceLine" id="cb14-16" title="16">    <span class="fu">==&gt;</span> <span class="fu">id</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) ((<span class="fu">+</span>) <span class="dv">0</span> <span class="dv">1</span>) <span class="dv">2</span>) <span class="dv">3</span>) <span class="co">--beta</span></a>
<a class="sourceLine" id="cb14-17" title="17">    <span class="fu">==&gt;</span> ((<span class="fu">+</span>) ((<span class="fu">+</span>) ((<span class="fu">+</span>) <span class="dv">0</span> <span class="dv">1</span>) <span class="dv">2</span>) <span class="dv">3</span>) <span class="co">-- inline id</span></a>
<a class="sourceLine" id="cb14-18" title="18">    <span class="fu">==&gt;</span> <span class="dv">6</span> <span class="co">-- simplify</span></a></code></pre></div>
<p>後半ではfold/build変換についてより詳しく解説します。</p>
    </section>
    
    <div id="disqus_thread"></div>
    <script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
    var disqus_config = function () {
    this.page.url = "https://autotaker.github.io" + "/posts/2019-02-15-list.html";  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = "/posts/2019-02-15-list.html"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://autotaker.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
        </div>
    </body>
</html>
